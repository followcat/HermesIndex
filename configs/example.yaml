# Global settings
gpu_endpoint: "http://localhost:8001"
embedding_model_version: "bge-m3"
nsfw_threshold: 0.7
local_embedder:
  enabled: false
  model_name: "BAAI/bge-m3"

search:
  # Optional query prefix for specific embedding models.
  # query_prefix: "Represent this sentence for searching relevant passages: "
  # Keyword search backend:
  # - "auto" (default): use bitmagnet GraphQL when configured, else fallback to Postgres keyword scan
  # - "pg": force Postgres keyword scan (can be slow on huge tables)
  keyword_backend: "auto"

postgres:
  dsn: "postgresql://user:password@localhost:5432/hermes"
  fetch_batch_size: 500

# Bitmagnet plugin (optional)
bitmagnet:
  enabled: false
  host: "127.0.0.1"
  port: 5432
  database: "bitmagnet"
  user: "followcat"
  password: "REPLACE_PASSWORD"
  schema: "hermes"
  create_schema: true
  # Optional: Bitmagnet GraphQL endpoint for fast keyword search on torrents.
  # Defaults to http://{bitmagnet.host}:3333/graphql when not set.
  graphql_endpoint: "http://127.0.0.1:3333/graphql"
  # graphql_scheme: "http"
  # graphql_port: 3333
  graphql_timeout_seconds: 15

# TMDB enrichment (optional, uses API key from env)
tmdb:
  enabled: false
  # api_key: "REPLACE_TMDB_KEY"
  api_key_env: "TMDB_API_KEY"
  base_url: "https://api.themoviedb.org/3"
  language: "zh-CN"
  sleep_seconds: 1.0
  timeout_seconds: 10
  auto_enrich: false
  max_per_batch: 50
  query_expand: true
  query_expand_limit: 20
  # imdb:
  #   enabled: false
  #   api_key_env: "OMDB_API_KEY"
  #   base_url: "https://www.omdbapi.com"
  # douban:
  #   enabled: false
  #   base_url: "https://api.douban.com/v2/movie/imdb"
  #   api_key_env: ""
  #   api_key_param: "apikey"
  # limits:
  #   actors: 10
  #   directors: 5
  #   aka: 10

# TPDB/Stash-Box enrichment (optional, requires GraphQL query/response path)
tpdb:
  enabled: false
  # api_token: "REPLACE_TPDB_TOKEN"
  api_token_env: "TPDB_API_TOKEN"
  endpoints:
    jav: "https://theporndb.net/graphql?type=JAV"
    movie: "https://theporndb.net/graphql?type=Movie"
  auth_header: "ApiKey"
  # auth_prefix: "Bearer"
  timeout_seconds: 15
  sleep_seconds: 1.0
  auto_enrich: false
  max_per_batch: 50
  default_type: "jav"
  search_limit: 10
  require_code: true
  cache_ttl_hours: 168
  not_found_ttl_hours: 720
  queries:
    jav: |
      query SearchScene($term: String!, $limit: Int) {
        searchScene(term: $term, limit: $limit) {
          id
          title
          details
          date
          release_date
          production_date
          duration
          director
          code
          urls { url site { name } }
          studio { id name }
          tags { name }
          images { url width height }
          performers { performer { name } }
        }
      }
    movie: |
      query SearchScene($term: String!, $limit: Int) {
        searchScene(term: $term, limit: $limit) {
          id
          title
          details
          date
          release_date
          production_date
          duration
          director
          code
          urls { url site { name } }
          studio { id name }
          tags { name }
          images { url width height }
          performers { performer { name } }
        }
      }
  result_paths:
    jav: "data.searchScene"
    movie: "data.searchScene"

# 简易认证（可选）
auth:
  enabled: false
  admin_user: "admin"
  admin_password: "CHANGE_ME"
  user_store_path: "data/users.json"
  token_store_path: "data/tokens.json"
  token_ttl_seconds: 86400

vector_store:
  type: "hnsw"
  path: "./data/index"
  max_elements: 1500000
  dim: 768
  metric: "cosine"
  ef_construction: 200
  M: 16
  ef_search: 64

# Qdrant 示例（启用时替换上方配置）：
# vector_store:
#   type: "qdrant"
#   url: "http://localhost:6333"
#   collection: "hermes_vectors"
#   dim: 768
#   metric: "cosine"
#   api_key: ""

# Milvus 示例：
# vector_store:
#   type: "milvus"
#   uri: "http://localhost:19530"
#   collection: "hermes_vectors"
#   dim: 768
#   metric: "cosine"

sync:
  batch_size: 256
  concurrency: 2

# Celery 调度（可选）
# celery:
#   broker_url: "redis://localhost:6379/0"
#   backend_url: "redis://localhost:6379/1"
#   schedule_seconds: 600  # 定时全量增量同步周期

sources:
  - name: "torrents"
    pg:
      table: "torrents"
      id_field: "id"
      text_field: "title"
      updated_at_field: "updated_at"   # optional
      extra_fields: ["category", "size"]
      size_field: "size"
      tpdb_enrich: true
      tpdb_type: "jav"
      tpdb_content_type: "torrent"
      tpdb_content_source: "torrents"
      where: "t.title ~* '(?<![A-Z0-9])[A-Z]{2,6}[-_ ]?[0-9]{2,5}(?![A-Z0-9])'"
    vector_index:
      index_name: "torrents_title_v1"
      dim: 768
      metric: "cosine"
    tagging:
      nsfw: true
    sync:
      mode: "incremental"
      batch_size: 256
      concurrency: 2
  - name: "files"
    pg:
      table: "files"
      id_field: "id"
      text_field: "name"
      tpdb_enrich: true
      tpdb_type: "jav"
      tpdb_content_type: "file"
      tpdb_content_source: "files"
      where: "t.name ~* '(?<![A-Z0-9])[A-Z]{2,6}[-_ ]?[0-9]{2,5}(?![A-Z0-9])'"
    vector_index:
      index_name: "files_name_v1"
      dim: 768
      metric: "cosine"
    tagging:
      nsfw: false

  - name: "content_tpdb_jav"
    pg:
      table: "hermes.content_view"
      id_field: "content_uid"
      text_field: "search_text"
      updated_at_field: "updated_at"
      extra_fields:
        [
          "title",
          "original_title",
          "overview",
          "type",
          "source",
          "id",
          "adult",
          "release_year",
          "tmdb_id",
          "genre",
          "aka",
          "keywords",
          "actors",
          "directors",
          "plot",
          "poster_path",
          "backdrop_path",
          "tpdb_id",
          "tpdb_title",
          "tpdb_original_title",
          "tpdb_aka",
          "tpdb_actors",
          "tpdb_tags",
          "tpdb_studio",
          "tpdb_series",
          "tpdb_site",
          "tpdb_release_date",
          "tpdb_plot",
          "tpdb_poster_url",
        ]
      tmdb_enrich: true
      tpdb_enrich: true
      tpdb_type: "jav"
      keyword_search: true
      keyword_fields: ["title", "original_title", "overview"]
    vector_index:
      index_name: "content_jav_title_v1"
      dim: 768
      metric: "cosine"
    tagging:
      nsfw: true
    sync:
      mode: "incremental"
      batch_size: 256
      concurrency: 2

  - name: "content_tpdb_movie"
    pg:
      table: "hermes.content_view"
      id_field: "content_uid"
      text_field: "search_text"
      updated_at_field: "updated_at"
      extra_fields:
        [
          "title",
          "original_title",
          "overview",
          "type",
          "source",
          "id",
          "adult",
          "release_year",
          "tmdb_id",
          "genre",
          "aka",
          "keywords",
          "actors",
          "directors",
          "plot",
          "poster_path",
          "backdrop_path",
          "tpdb_id",
          "tpdb_title",
          "tpdb_original_title",
          "tpdb_aka",
          "tpdb_actors",
          "tpdb_tags",
          "tpdb_studio",
          "tpdb_series",
          "tpdb_site",
          "tpdb_release_date",
          "tpdb_plot",
          "tpdb_poster_url",
        ]
      tmdb_enrich: true
      tpdb_enrich: true
      tpdb_type: "movie"
      keyword_search: true
      keyword_fields: ["title", "original_title", "overview"]
    vector_index:
      index_name: "content_movie_title_v1"
      dim: 768
      metric: "cosine"
    tagging:
      nsfw: true
    sync:
      mode: "incremental"
      batch_size: 256
      concurrency: 2
